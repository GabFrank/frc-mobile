<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/operaciones"></ion-back-button>
    </ion-buttons>
    <ion-title>Recepción de Mercadería</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="ion-padding">
    <!-- Validación de Ubicación -->
    <ion-card
      style="
        background: #333333;
        border-radius: 8px;
        margin: 10px;
        border-left: 4px solid #f57c00;
      "
    >
      <ion-card-content style="padding: 12px">
        <ion-row>
          <ion-col size="12">
            <div style="text-align: center">
              <ion-icon
                [name]="ubicacionValidada ? 'checkmark-circle' : 'location-outline'"
                [style.color]="ubicacionValidada ? '#43a047' : '#f57c00'"
                style="font-size: 2em; margin-bottom: 10px"
              >
              </ion-icon>
              <h3 style="color: white; margin: 10px 0; font-weight: 600">
                {{ ubicacionValidada ? 'Ubicación Validada' : 'Validar
                Ubicación' }}
              </h3>
              <p style="color: white; margin: 5px 0; font-size: 0.9rem">
                {{ ubicacionValidada ? 'Sucursal: ' + (sucursalValidada?.nombre
                || '') : 'Debes validar tu ubicación para continuar' }}
              </p>
              <ion-button
                *ngIf="!ubicacionValidada"
                (click)="onValidarUbicacion()"
                expand="block"
                shape="round"
                style="margin-top: 15px"
              >
                <ion-icon name="location" slot="start"></ion-icon>
                Validar Ubicación
              </ion-button>
              <ion-button
                *ngIf="ubicacionValidada"
                (click)="onValidarUbicacion()"
                expand="block"
                shape="round"
                fill="clear"
                style="color: #f57c00; margin-top: 15px"
              >
                <ion-icon name="refresh" slot="start"></ion-icon>
                Cambiar Ubicación
              </ion-button>
            </div>
          </ion-col>
        </ion-row>
      </ion-card-content>
    </ion-card>

    <!-- Formulario de Búsqueda -->
    <form [formGroup]="recepcionForm">
      <ion-card style="background: #252525; border-radius: 8px; margin: 10px">
        <ion-card-content
          style="
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
          "
        >
          <ion-item>
            <ion-label position="floating">Proveedor (opcional)</ion-label>
            <ion-input 
              [value]="selectedProveedor ? selectedProveedor.persona.nombre : ''"
              placeholder="Selecciona un proveedor"
              readonly
              style="color: white;">
            </ion-input>
            <ion-icon
              name="search-outline"
              slot="end"
              (click)="openProveedorSearchModal()"
              style="cursor: pointer; color: #f57c00;">
            </ion-icon>
          </ion-item>
          
          <!-- Mostrar proveedor seleccionado -->
          <div *ngIf="selectedProveedor" style="background: #333333; border-radius: 8px; padding: 10px; margin: 5px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <p style="color: #43a047; margin: 0; font-size: 0.9rem;">
                  <strong>Proveedor seleccionado:</strong> {{selectedProveedor.persona.nombre}}
                </p>
                <p style="color: #999; margin: 5px 0 0 0; font-size: 0.8rem;">
                  Documento: {{selectedProveedor.persona.documento}} | Tel: {{selectedProveedor.persona.telefono}}
                </p>
              </div>
              <ion-button 
                fill="clear" 
                size="small" 
                color="danger"
                (click)="clearProveedor()"
                style="margin: 0;">
                <ion-icon name="close"></ion-icon>
              </ion-button>
            </div>
          </div>
          
          <ion-item>
            <ion-label position="floating">Nro. de Nota de Recepción</ion-label>
            <ion-input formControlName="numeroNota"></ion-input>
            <ion-icon
              name="search-outline"
              slot="end"
              (click)="openSearchModal()"
            ></ion-icon>
          </ion-item>
        </ion-card-content>
      </ion-card>
    </form>

    <!-- Lista de Notas Seleccionadas -->
    <ion-card style="background: #252525; border-radius: 8px; margin: 10px">
      <ion-card-content style="padding: 12px">
        <ion-row>
          <ion-col size="12">
            <h3
              style="
                color: #f57c00;
                margin: 10px 0;
                font-weight: 600;
                text-align: center;
              "
            >
              Notas a Recepcionar en esta Sesión
            </h3>
            <p
              style="
                color: white;
                margin: 5px 0;
                font-size: 0.9rem;
                text-align: center;
              "
            >
              {{ selectedNotas.length }} nota(s) seleccionada(s)
            </p>
          </ion-col>
        </ion-row>
      </ion-card-content>
    </ion-card>

    <ion-list>
      <ion-item
        *ngFor="let nota of selectedNotas"
        style="background: #333333; border-radius: 8px; margin: 5px 0"
      >
        <ion-label>
          <h2 style="color: white; font-weight: 600">ID: {{nota.id}}</h2>
          <p style="color: white; margin: 5px 0; font-size: 0.9rem">
            Número: {{nota.numero}} | Fecha: {{nota.fecha | date}}
          </p>
          <p style="color: #43a047; margin: 5px 0; font-size: 0.8rem">
            Estado: {{nota.estado}}
          </p>
          <p style="color: #999; margin: 5px 0; font-size: 0.8rem">
            Moneda: {{nota.moneda?.denominacion}} ({{nota.moneda?.simbolo}})
          </p>
          <p *ngIf="nota.pedido?.proveedor" style="color: #f57c00; margin: 5px 0; font-size: 0.8rem">
            Proveedor: {{nota.pedido.proveedor.persona.nombre}}
          </p>
          <p *ngIf="nota.compra?.proveedor" style="color: #f57c00; margin: 5px 0; font-size: 0.8rem">
            Proveedor: {{nota.compra.proveedor.persona.nombre}}
          </p>
        </ion-label>
        <ion-button
          fill="clear"
          color="danger"
          (click)="removeNotaFromList(nota)"
        >
          <ion-icon name="close"></ion-icon>
        </ion-button>
      </ion-item>
    </ion-list>

    <!-- Mensaje cuando no hay notas -->
    <div
      *ngIf="selectedNotas.length === 0"
      style="text-align: center; padding: 40px"
    >
      <ion-icon
        name="document-outline"
        style="font-size: 3em; color: #666; margin-bottom: 20px"
      ></ion-icon>
      <p style="color: #666; font-size: 1rem">No hay notas seleccionadas</p>
      <p style="color: #999; font-size: 0.9rem">
        Usa el buscador para agregar notas de recepción
      </p>
    </div>
  </div>
</ion-content>

<ion-footer>
  <ion-toolbar>
    <ion-button
      expand="block"
      fill="solid"
      color="success"
      [disabled]="!puedeIniciarRecepcion"
      (click)="onIniciarRecepcion()"
    >
      <ion-icon name="play" slot="start"></ion-icon>
      Iniciar Recepción
    </ion-button>
  </ion-toolbar>
</ion-footer>
