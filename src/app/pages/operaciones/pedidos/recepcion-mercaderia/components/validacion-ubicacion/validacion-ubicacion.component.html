<ion-content>
  <div class="content-container">
    <ion-card style="background: #333333; border-radius: 8px; margin: 10px;">
      <ion-card-content style="padding: 12px;">
        <ion-row>
          <ion-col size="12">
            <h2 class="titulo-center" style="color: #f57c00; font-weight: 600; margin: 0;">
              Validación de Ubicación
            </h2>
            <p style="color: white; text-align: center; margin: 10px 0; font-size: 0.9rem;">
              {{ isWeb ? 'Selecciona la sucursal manualmente' : 'Verificando que estés en la sucursal correcta' }}
            </p>
          </ion-col>
        </ion-row>
      </ion-card-content>
    </ion-card>

    <!-- Toggle Mode Buttons -->
    <ion-card style="background: #252525; border-radius: 8px; margin: 10px;">
      <ion-card-content style="padding: 12px;">
        <ion-row>
          <ion-col size="6">
            <ion-button 
              (click)="onCambiarAGPS()" 
              expand="block" 
              shape="round"
              [color]="!showManualSelector ? 'primary' : 'medium'"
              [disabled]="isWeb">
              <ion-icon name="location" slot="start"></ion-icon>
              GPS
            </ion-button>
          </ion-col>
          <ion-col size="6">
            <ion-button 
              (click)="onCambiarAModoManual()" 
              expand="block" 
              shape="round"
              [color]="showManualSelector ? 'primary' : 'medium'">
              <ion-icon name="list" slot="start"></ion-icon>
              Manual
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-card-content>
    </ion-card>

    <!-- Manual Sucursal Selector (Web Mode) -->
    <ion-card *ngIf="showManualSelector" style="background: #252525; border-radius: 8px; margin: 10px;">
      <ion-card-content style="padding: 12px;">
        <ion-row>
          <ion-col size="12">
            <p style="color: #f57c00; font-size: 0.9rem; margin: 10px 0; font-weight: 500; text-align: center;">
              Selecciona la Sucursal de Recepción
            </p>
            
            <!-- Botón para abrir lista de sucursales -->
            <ion-button 
              (click)="onSeleccionarSucursalDesdeLista()" 
              expand="block" 
              shape="round"
              style="margin-bottom: 15px;">
              <ion-icon name="list" slot="start"></ion-icon>
              Seleccionar Sucursal
            </ion-button>

            <!-- Información de la sucursal seleccionada -->
            <div *ngIf="selectedSucursal" style="background: #333333; border-radius: 8px; padding: 15px; margin: 15px 0; text-align: center;">
              <ion-icon name="checkmark-circle" style="font-size: 2em; color: #43a047; margin-bottom: 10px;"></ion-icon>
              <h3 style="color: white; margin: 10px 0; font-weight: 600;">Sucursal Seleccionada</h3>
              <p style="color: #43a047; margin: 5px 0; font-size: 1.1rem; font-weight: 500;">
                {{selectedSucursal.nombre}}
              </p>
              <p *ngIf="selectedSucursal.ciudad?.descripcion" style="color: #999; margin: 5px 0; font-size: 0.9rem;">
                Ciudad: {{selectedSucursal.ciudad.descripcion}}
              </p>
              <ion-button 
                fill="clear" 
                size="small" 
                color="danger"
                (click)="clearSucursal()"
                style="margin-top: 10px;">
                <ion-icon name="close" slot="start"></ion-icon>
                Cambiar Sucursal
              </ion-button>
            </div>
          </ion-col>
        </ion-row>
      </ion-card-content>
    </ion-card>

    <!-- Loading State -->
    <div *ngIf="isLoading" style="text-align: center; padding: 40px;">
      <ion-spinner name="lines" style="width: 50px; height: 50px; color: #f57c00;"></ion-spinner>
      <p style="color: white; margin-top: 20px;">Obteniendo tu ubicación...</p>
    </div>

    <!-- Map Container (GPS Mode) -->
    <div *ngIf="!isLoading && userPosition && !showManualSelector" class="map-container">
      <div #mapContainer id="map" style="width: 100%; height: 100%"></div>
    </div>

    <!-- Success State -->
    <ion-card *ngIf="isInSucursal && selectedSucursal" style="background: #43a047; border-radius: 8px; margin: 10px; border-left: 4px solid #43a047;">
      <ion-card-content style="padding: 12px;">
        <ion-row>
          <ion-col size="12">
            <div style="text-align: center; color: white;">
              <ion-icon name="checkmark-circle" style="font-size: 2em; margin-bottom: 10px;"></ion-icon>
              <h3 style="margin: 10px 0; font-weight: 600;">¡Ubicación Validada!</h3>
              <p style="margin: 5px 0; font-size: 1.1rem;">Estás en: <strong>{{selectedSucursal.nombre}}</strong></p>
            </div>
          </ion-col>
        </ion-row>
      </ion-card-content>
    </ion-card>

    <!-- Error State (GPS Mode) -->
    <ion-card *ngIf="!isLoading && userPosition && !isInSucursal && !showManualSelector" style="background: #f44336; border-radius: 8px; margin: 10px; border-left: 4px solid #f44336;">
      <ion-card-content style="padding: 12px;">
        <ion-row>
          <ion-col size="12">
            <div style="text-align: center; color: white;">
              <ion-icon name="alert-circle" style="font-size: 2em; margin-bottom: 10px;"></ion-icon>
              <h3 style="margin: 10px 0; font-weight: 600;">Ubicación No Válida</h3>
              <p style="margin: 5px 0; font-size: 1rem;">No estás en una sucursal válida para la recepción</p>
            </div>
          </ion-col>
        </ion-row>
      </ion-card-content>
    </ion-card>

    <!-- Confirm Button (only when location is validated) -->
    <div *ngIf="isInSucursal && selectedSucursal" style="text-align: center; margin: 20px 10px;">
      <ion-button 
        (click)="onConfirmarUbicacion()" 
        expand="block" 
        shape="round"
        class="btn-success"
        style="height: 50px; font-size: 1.1rem;">
        <ion-icon name="checkmark" slot="start"></ion-icon>
        Confirmar Ubicación
      </ion-button>
    </div>
  </div>
</ion-content>

<!-- Footer with Cancel and Retry buttons -->
<ion-footer style="background: #252525; padding: 20px;">
  <ion-row>
    <ion-col size="12">
      <ion-button 
        (click)="onCancelar()" 
        expand="block" 
        shape="round"
        fill="clear"
        style="color: #f57c00; margin-bottom: 10px; height: 45px;">
        <ion-icon name="close" slot="start"></ion-icon>
        Cancelar
      </ion-button>
      
      <ion-button 
        *ngIf="userPosition && !showManualSelector"
        (click)="onReintentar()" 
        expand="block" 
        shape="round"
        fill="clear"
        style="color: #f57c00; height: 45px;">
        <ion-icon name="refresh" slot="start"></ion-icon>
        Reintentar
      </ion-button>
    </ion-col>
  </ion-row>
</ion-footer> 